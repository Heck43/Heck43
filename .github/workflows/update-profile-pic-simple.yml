name: Update Profile Picture from ImgBB

on:
  schedule:
    - cron: "0 * * * *"  # –ö–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
        
      - name: Get Random Image from ImgBB Album
        run: |
          # ImgBB API –∫–ª—é—á
          API_KEY="8210be0791dd4e570500e79ed8d8d54f"
          
          # ID –∞–ª—å–±–æ–º–∞ (–∏–∑ —Å—Å—ã–ª–∫–∏ https://ibb.co/album/6R58df)
          ALBUM_ID="6R58df"
          
          # –ü–∞—Ä—Å–∏–º –∞–ª—å–±–æ–º –∏ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫
          echo "–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ –∞–ª—å–±–æ–º–∞..."
          
          # –ü–∞—Ä—Å–∏–º HTML –∞–ª—å–±–æ–º–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (next/seek) –∏ —Å–æ–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä
          VIEWS=""
          CURRENT_URL="https://ibb.co/album/$ALBUM_ID?page=1"
          PAGE_NUM=1
          MAX_PAGES=50
          while [ "$PAGE_NUM" -le "$MAX_PAGES" ]; do
            PAGE=$(curl -sL -A "Mozilla/5.0" "$CURRENT_URL")
            PAGE_VIEWS_ABS=$(echo "$PAGE" | grep -oP 'https://ibb\.co/[^"]+' | grep -v '/album/' || true)
            PAGE_VIEWS_REL=$(echo "$PAGE" | grep -oP 'href="/[A-Za-z0-9]+"' | sed 's/href="\(.*\)"/\1/' | grep -v '^/album/' || true)
            PAGE_VIEWS=$(printf "%s\n%s\n" "$PAGE_VIEWS_ABS" "$PAGE_VIEWS_REL" | sed 's|^/|https://ibb.co/|' | sed '/^$/d' | sort -u)
            PAGE_COUNT=$(echo "$PAGE_VIEWS" | sed '/^$/d' | wc -l | tr -d ' ')
            if [ "$PAGE_COUNT" -eq 0 ]; then
              break
            fi
            VIEWS="${VIEWS}${PAGE_VIEWS}"$'\n'
            NEXT_URL=$(echo "$PAGE" | grep -oP 'data-pagination="next"[^>]*href="\\K[^"]+' || true)
            if [ -z "$NEXT_URL" ]; then
              SEEK=$(echo "$PAGE" | grep -oP 'data-action="load-more"[^>]*data-seek="\\K[^"]+' | head -n 1 || true)
              if [ -n "$SEEK" ]; then
                NEXT_PAGE=$((PAGE_NUM + 1))
                NEXT_URL="https://ibb.co/album/$ALBUM_ID?page=$NEXT_PAGE&seek=$SEEK"
              fi
            fi
            if [ -z "$NEXT_URL" ]; then
              echo "–°—Ç—Ä–∞–Ω–∏—Ü–∞ $PAGE_NUM: –Ω–∞–π–¥–µ–Ω–æ $PAGE_COUNT, next=–Ω–µ—Ç"
              break
            fi
            NEXT_URL=$(echo "$NEXT_URL" | sed 's/&amp;/\\&/g')
            case "$NEXT_URL" in
              http*) ;;
              /*) NEXT_URL="https://ibb.co$NEXT_URL" ;;
              *) NEXT_URL="https://ibb.co/$NEXT_URL" ;;
            esac
            echo "–°—Ç—Ä–∞–Ω–∏—Ü–∞ $PAGE_NUM: –Ω–∞–π–¥–µ–Ω–æ $PAGE_COUNT, next=$NEXT_URL"
            CURRENT_URL="$NEXT_URL"
            PAGE_NUM=$((PAGE_NUM + 1))
          done
          VIEWS=$(echo "$VIEWS" | sed '/^$/d' | sort -u)
          
          # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä
          VIEW_COUNT=$(echo "$VIEWS" | wc -l | tr -d ' ')
          echo "–ù–∞–π–¥–µ–Ω–æ $VIEW_COUNT —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä"
          
          if [ "$VIEW_COUNT" -eq 0 ]; then
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ –∞–ª—å–±–æ–º–∞"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–±—ã –æ—Ç—Å–µ—è—Ç—å –±–∏—Ç—ã–µ/–Ω–µ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          is_valid_image() {
            local url="$1"
            local headers status ctype clen
            headers=$(curl -sIL -A "Mozilla/5.0" "$url" | tr -d '\r')
            status=$(echo "$headers" | awk 'tolower($0) ~ /^http/ {code=$2} END{print code}')
            ctype=$(echo "$headers" | awk -F': ' 'tolower($1)=="content-type" {print tolower($2); exit}')
            clen=$(echo "$headers" | awk -F': ' 'tolower($1)=="content-length" {print $2; exit}')
            if [ "$status" != "200" ]; then
              return 1
            fi
            if [ -n "$ctype" ] && [[ "$ctype" != image/* ]]; then
              return 1
            fi
            if [ -n "$clen" ] && [ "$clen" -gt 10000000 ]; then
              return 1
            fi
            return 0
          }
          
          # –í—ã–±–∏—Ä–∞–µ–º —Ä–∞–Ω–¥–æ–º–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É
          NEW_IMAGE=""
          ATTEMPTS=0
          MAX_ATTEMPTS=5
          while [ "$ATTEMPTS" -lt "$MAX_ATTEMPTS" ]; do
            RANDOM_LINE=$((RANDOM % VIEW_COUNT + 1))
            VIEW_URL=$(echo "$VIEWS" | sed -n "${RANDOM_LINE}p")
            VIEW_PAGE=$(curl -sL -A "Mozilla/5.0" "$VIEW_URL")
            CANDIDATE=$(echo "$VIEW_PAGE" | grep -oP '<meta property="og:image" content="\K[^"]+')
            if [ -n "$CANDIDATE" ] && is_valid_image "$CANDIDATE"; then
              NEW_IMAGE="$CANDIDATE"
              break
            fi
            ATTEMPTS=$((ATTEMPTS + 1))
          done
          
          if [ -z "$NEW_IMAGE" ]; then
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –≤–∞–ª–∏–¥–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∑–∞ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
            exit 1
          fi
          
          # –û–±—Ö–æ–¥–∏–º –∫—ç—à GitHub –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          CACHE_BUST=$(date +%s)
          NEW_IMAGE="${NEW_IMAGE}?v=${CACHE_BUST}"
          
          echo "–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞: $NEW_IMAGE"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ README
          CURRENT_IMAGE=$(grep -oP '<img src="\K[^"]+(?=" width="350")' README.md)
          echo "–¢–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞: $CURRENT_IMAGE"
          
          # –ï—Å–ª–∏ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ —Ç–µ–∫—É—â–∞—è, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é
          if [ "$NEW_IMAGE" == "$CURRENT_IMAGE" ] && [ "$VIEW_COUNT" -gt 1 ]; then
            echo "–í—ã–±—Ä–∞–Ω–∞ —Ç–∞ –∂–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é..."
            RANDOM_LINE=$((RANDOM % VIEW_COUNT + 1))
            VIEW_URL=$(echo "$VIEWS" | sed -n "${RANDOM_LINE}p")
            VIEW_PAGE=$(curl -sL -A "Mozilla/5.0" "$VIEW_URL")
            NEW_IMAGE=$(echo "$VIEW_PAGE" | grep -oP '<meta property="og:image" content="\\K[^"]+')
            echo "–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞: $NEW_IMAGE"
          fi
          
          # –ó–∞–º–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ README (–∏—â–µ–º –ª—é–±—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Å width="350")
          sed -i "s|<img src=\"[^\"]*\" width=\"350\"|<img src=\"$NEW_IMAGE\" width=\"350\"|g" README.md
          
          echo "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
          
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          else
            git commit -m "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (Loona)"
            git push
          fi
