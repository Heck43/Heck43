name: Update Profile Picture from ImgBB

on:
  schedule:
    - cron: "0 * * * *"  # –ö–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
        
      - name: Get Random Image from ImgBB Album
        run: |
          # ImgBB API –∫–ª—é—á
          API_KEY="8210be0791dd4e570500e79ed8d8d54f"
          
          # ID –∞–ª—å–±–æ–º–∞ (–∏–∑ —Å—Å—ã–ª–∫–∏ https://ibb.co/album/6R58df)
          ALBUM_ID="6R58df"
          
          # –ü–∞—Ä—Å–∏–º –∞–ª—å–±–æ–º –∏ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫
          echo "–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ –∞–ª—å–±–æ–º–∞..."
          
          # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ API, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
          API_URL="https://api.imgbb.com/1/album/$ALBUM_ID?key=$API_KEY"
          IMAGES=""
          PAGE_NUM=1
          MAX_PAGES=50
          while [ "$PAGE_NUM" -le "$MAX_PAGES" ]; do
            API_JSON=$(curl -s "${API_URL}&page=${PAGE_NUM}")
            PAGE_IMAGES=$(echo "$API_JSON" | jq -r '.data.images[]? | .url // .image?.url // .thumb?.url // empty' \
              | grep -E 'https://i\.ibb\.co/[^"]+\.(webp|png|jpg|gif)$' || true)
            PAGE_COUNT=$(echo "$PAGE_IMAGES" | sed '/^$/d' | wc -l | tr -d ' ')
            if [ "$PAGE_COUNT" -eq 0 ]; then
              break
            fi
            IMAGES="${IMAGES}${PAGE_IMAGES}"$'\n'
            PAGE_NUM=$((PAGE_NUM + 1))
          done
          IMAGES=$(echo "$IMAGES" | sed '/^$/d' | sort -u)
          
          # –ï—Å–ª–∏ API –Ω–µ –¥–∞–ª —Å—Å—ã–ª–æ–∫, fallback –Ω–∞ HTML
          if [ -z "$IMAGES" ]; then
            PAGE=$(curl -s "https://ibb.co/album/$ALBUM_ID")
            IMAGES=$(echo "$PAGE" | grep -oP 'https://i\.ibb\.co/[^"]+\.(webp|png|jpg|gif)' | sort -u)
          fi
          
          # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫
          IMAGE_COUNT=$(echo "$IMAGES" | wc -l | tr -d ' ')
          echo "–ù–∞–π–¥–µ–Ω–æ $IMAGE_COUNT –∫–∞—Ä—Ç–∏–Ω–æ–∫"
          
          if [ "$IMAGE_COUNT" -eq 0 ]; then
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ –∞–ª—å–±–æ–º–∞"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–±—ã –æ—Ç—Å–µ—è—Ç—å –±–∏—Ç—ã–µ/–Ω–µ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          is_valid_image() {
            local url="$1"
            local headers status ctype clen
            headers=$(curl -sIL -A "Mozilla/5.0" "$url" | tr -d '\r')
            status=$(echo "$headers" | awk 'tolower($0) ~ /^http/ {code=$2} END{print code}')
            ctype=$(echo "$headers" | awk -F': ' 'tolower($1)=="content-type" {print tolower($2); exit}')
            clen=$(echo "$headers" | awk -F': ' 'tolower($1)=="content-length" {print $2; exit}')
            if [ "$status" != "200" ]; then
              return 1
            fi
            if [ -n "$ctype" ] && [[ "$ctype" != image/* ]]; then
              return 1
            fi
            if [ -n "$clen" ] && [ "$clen" -gt 10000000 ]; then
              return 1
            fi
            return 0
          }
          
          # –í—ã–±–∏—Ä–∞–µ–º —Ä–∞–Ω–¥–æ–º–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ–ø—ã—Ç–æ–∫)
          NEW_IMAGE=""
          ATTEMPTS=0
          MAX_ATTEMPTS=5
          while [ "$ATTEMPTS" -lt "$MAX_ATTEMPTS" ]; do
            RANDOM_LINE=$((RANDOM % IMAGE_COUNT + 1))
            CANDIDATE=$(echo "$IMAGES" | sed -n "${RANDOM_LINE}p")
            if is_valid_image "$CANDIDATE"; then
              NEW_IMAGE="$CANDIDATE"
              break
            fi
            ATTEMPTS=$((ATTEMPTS + 1))
          done
          
          if [ -z "$NEW_IMAGE" ]; then
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –≤–∞–ª–∏–¥–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∑–∞ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
            exit 1
          fi
          
          # –û–±—Ö–æ–¥–∏–º –∫—ç—à GitHub –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          CACHE_BUST=$(date +%s)
          NEW_IMAGE="${NEW_IMAGE}?v=${CACHE_BUST}"
          
          echo "–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞: $NEW_IMAGE"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ README
          CURRENT_IMAGE=$(grep -oP '<img src="\K[^"]+(?=" width="350")' README.md)
          echo "–¢–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞: $CURRENT_IMAGE"
          
          # –ï—Å–ª–∏ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ —Ç–µ–∫—É—â–∞—è, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é
          if [ "$NEW_IMAGE" == "$CURRENT_IMAGE" ] && [ "$IMAGE_COUNT" -gt 1 ]; then
            echo "–í—ã–±—Ä–∞–Ω–∞ —Ç–∞ –∂–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é..."
            RANDOM_LINE=$((RANDOM % IMAGE_COUNT + 1))
            NEW_IMAGE=$(echo "$IMAGES" | sed -n "${RANDOM_LINE}p")
            echo "–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞: $NEW_IMAGE"
          fi
          
          # –ó–∞–º–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ README (–∏—â–µ–º –ª—é–±—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Å width="350")
          sed -i "s|<img src=\"[^\"]*\" width=\"350\"|<img src=\"$NEW_IMAGE\" width=\"350\"|g" README.md
          
          echo "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
          
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          else
            git commit -m "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (Loona)"
            git push
          fi
