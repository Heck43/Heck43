name: Update Profile Picture from ImgBB

on:
  schedule:
    - cron: "0 * * * *"  # –∫–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright (Chromium)
        run: |
          npm init -y >/dev/null 2>&1
          npm i --no-save playwright
          npx playwright install --with-deps chromium

      - name: Pick random image from ImgBB album (loads ALL)
        env:
          ALBUM_ID: "6R58df"
        run: |
          node <<'NODE'
          const fs = require('fs');
          const { chromium } = require('playwright');

          const albumId = process.env.ALBUM_ID;
          const albumUrl = `https://ibb.co/album/${albumId}`;
          const readmePath = 'README.md';

          function extractCurrentImageUrl(readme) {
            // –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º src —É <img ... width="350"
            const m = readme.match(/<img\s+src="([^"]+)"\s+width="350"/i);
            if (!m) return null;
            return m[1].split('?')[0]; // –±–µ–∑ cache-bust
          }

          function unique(arr) {
            return [...new Set(arr)];
          }

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext({
              locale: 'en-US',
              userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36'
            });
            const page = await context.newPage();

            const readme = fs.existsSync(readmePath) ? fs.readFileSync(readmePath, 'utf8') : '';
            const current = extractCurrentImageUrl(readme);

            console.log(`Opening album: ${albumUrl}`);
            await page.goto(albumUrl, { waitUntil: 'domcontentloaded', timeout: 60000 });

            // –§—É–Ω–∫—Ü–∏—è: —Å–æ–±—Ä–∞—Ç—å id –∫–∞—Ä—Ç–∏–Ω–æ–∫ (viewer ids) —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            async function collectViewerIds() {
              const hrefs = await page.$$eval('a[href]', as => as.map(a => a.getAttribute('href')).filter(Boolean));
              // viewer —Å—Å—ã–ª–∫–∏ –æ–±—ã—á–Ω–æ –≤–∏–¥–∞ "/Ab12CdE" (–µ—Å—Ç—å —Ü–∏—Ñ—Ä—ã), –∏—Å–∫–ª—é—á–∞–µ–º /album/...
              const ids = hrefs
                .filter(h => /^\/[A-Za-z0-9]{5,12}$/.test(h))
                .map(h => h.slice(1))
                .filter(id => /\d/.test(id)); // —á—Ç–æ–±—ã –Ω–µ —Å—Ö–≤–∞—Ç–∏—Ç—å /login, /about –∏ —Ç.–ø.
              return unique(ids);
            }

            // –ñ–º—ë–º "Load more" –ø–æ–∫–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç
            let ids = await collectViewerIds();
            console.log(`Initially visible images: ${ids.length}`);

            const loadMoreLocator = page.locator('button:has-text("Load more"), a:has-text("Load more")');

            for (let i = 0; i < 60; i++) { // –ª–∏–º–∏—Ç –Ω–∞ –≤—Å—è–∫–∏–π
              const btnCount = await loadMoreLocator.count();
              if (btnCount === 0) break;

              const before = ids.length;

              try {
                const btn = loadMoreLocator.first();
                await btn.scrollIntoViewIfNeeded();
                await btn.click({ timeout: 7000 });
              } catch (e) {
                // –µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –≤—ã—à–µ–ª ‚Äî –≤—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è
                break;
              }

              // –∂–¥—ë–º —á—É—Ç—å-—á—É—Ç—å –∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫
              await page.waitForTimeout(1200);
              const next = await collectViewerIds();
              ids = next;

              console.log(`After Load more #${i + 1}: ${ids.length}`);

              if (ids.length <= before) {
                // –±–æ–ª—å—à–µ –Ω–µ —Ä–∞—Å—Ç—ë—Ç ‚Äî –∑–Ω–∞—á–∏—Ç –≤—Å—ë
                break;
              }
            }

            if (!ids.length) {
              console.error('No images found in album after loading.');
              process.exit(1);
            }

            console.log(`Total collected viewer ids: ${ids.length}`);

            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é (–∏ –Ω–µ —Ç–µ–∫—É—â—É—é)
            function pickRandom(arr) {
              return arr[Math.floor(Math.random() * arr.length)];
            }

            let chosenUrl = null;
            for (let attempt = 0; attempt < 12; attempt++) {
              const id = pickRandom(ids);
              const viewerUrl = `https://ibb.co/${id}`;

              await page.goto(viewerUrl, { waitUntil: 'domcontentloaded', timeout: 60000 });

              // og:image –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É i.ibb.co
              const og = await page.locator('meta[property="og:image"]').getAttribute('content').catch(() => null);
              const direct = og && og.startsWith('https://i.ibb.co/') ? og : null;

              if (!direct) continue;

              const base = direct.split('?')[0];
              if (current && base === current && ids.length > 1) {
                continue; // –Ω–µ –±–µ—Ä—ë–º —Ç—É –∂–µ —Å–∞–º—É—é
              }

              // cache bust –¥–ª—è GitHub
              chosenUrl = `${base}?v=${Date.now()}`;
              break;
            }

            if (!chosenUrl) {
              console.error('Failed to choose a valid direct image URL.');
              process.exit(1);
            }

            // –ü–µ—Ä–µ–¥–∞—ë–º –≤ —Å–ª–µ–¥—É—é—â–∏–π step —á–µ—Ä–µ–∑ $GITHUB_ENV
            fs.appendFileSync(process.env.GITHUB_ENV, `NEW_IMAGE=${chosenUrl}\n`);
            console.log(`Chosen: ${chosenUrl}`);

            await browser.close();
          })();
          NODE

      - name: Update README
        run: |
          python3 - <<'PY'
          import os, re, pathlib

          new = os.environ["NEW_IMAGE"]
          p = pathlib.Path("README.md")
          text = p.read_text(encoding="utf-8")

          pattern = r'<img\s+src="[^"]*"\s+width="350"'
          repl = f'<img src="{new}" width="350"'

          updated, n = re.subn(pattern, repl, text, flags=re.IGNORECASE)
          if n == 0:
            raise SystemExit("‚ùå –ù–µ –Ω–∞—à—ë–ª <img ... width=\"350\"> –≤ README.md")

          p.write_text(updated, encoding="utf-8")
          print(f"‚úÖ Updated {n} occurrence(s)")
          PY

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          else
            git commit -m "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è"
            git push
          fi
