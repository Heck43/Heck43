name: Update Profile Picture from ImgBB

on:
  schedule:
    - cron: "0 * * * *"  # –ö–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
        
      - name: Get Random Image from ImgBB Album
        run: |
          # ImgBB API –∫–ª—é—á
          API_KEY="8210be0791dd4e570500e79ed8d8d54f"
          
          # ID –∞–ª—å–±–æ–º–∞ (–∏–∑ —Å—Å—ã–ª–∫–∏ https://ibb.co/album/6R58df)
          ALBUM_ID="6R58df"
          
          # –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–ª—å–±–æ–º–∞ –∏ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫
          echo "–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ –∞–ª—å–±–æ–º–∞..."
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–ª—å–±–æ–º–∞
          PAGE=$(curl -s "https://ibb.co/album/$ALBUM_ID")
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–∏—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω i.ibb.co)
          IMAGES=$(echo "$PAGE" | grep -oP 'https://i\.ibb\.co/[^"]+\.(webp|png|jpg|gif)' | sort -u)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫–∏, —á—Ç–æ–±—ã –æ—Ç—Å–µ—è—Ç—å –±–∏—Ç—ã–µ/–Ω–µ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          is_valid_image() {
            local url="$1"
            local headers status ctype clen
            headers=$(curl -sIL -A "Mozilla/5.0" "$url" | tr -d '\r')
            status=$(echo "$headers" | awk 'tolower($0) ~ /^http\\// {code=$2} END{print code}')
            ctype=$(echo "$headers" | awk -F': ' 'tolower($1)=="content-type" {print tolower($2); exit}')
            clen=$(echo "$headers" | awk -F': ' 'tolower($1)=="content-length" {print $2; exit}')
            if [ "$status" != "200" ]; then
              return 1
            fi
            if [ -n "$ctype" ] && [[ "$ctype" != image/* ]]; then
              return 1
            fi
            if [ -n "$clen" ] && [ "$clen" -gt 10000000 ]; then
              return 1
            fi
            return 0
          }
          
          VALID_IMAGES=""
          while read -r url; do
            [ -z "$url" ] && continue
            if is_valid_image "$url"; then
              VALID_IMAGES="${VALID_IMAGES}${url}"$'\n'
            fi
          done <<< "$IMAGES"
          
          if [ -n "$VALID_IMAGES" ]; then
            IMAGES="$VALID_IMAGES"
          fi
          
          # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫
          IMAGE_COUNT=$(echo "$IMAGES" | wc -l | tr -d ' ')
          echo "–ù–∞–π–¥–µ–Ω–æ $IMAGE_COUNT –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫"
          
          if [ "$IMAGE_COUNT" -eq 0 ]; then
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ –∞–ª—å–±–æ–º–∞"
            exit 1
          fi
          
          # –í—ã–±–∏—Ä–∞–µ–º —Ä–∞–Ω–¥–æ–º–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
          RANDOM_LINE=$((RANDOM % IMAGE_COUNT + 1))
          NEW_IMAGE=$(echo "$IMAGES" | sed -n "${RANDOM_LINE}p")
          
          # –û–±—Ö–æ–¥–∏–º –∫—ç—à GitHub –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          CACHE_BUST=$(date +%s)
          NEW_IMAGE="${NEW_IMAGE}?v=${CACHE_BUST}"
          
          echo "–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞: $NEW_IMAGE"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ README
          CURRENT_IMAGE=$(grep -oP '<img src="\K[^"]+(?=" width="350")' README.md)
          echo "–¢–µ–∫—É—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞: $CURRENT_IMAGE"
          
          # –ï—Å–ª–∏ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ —Ç–µ–∫—É—â–∞—è, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é
          if [ "$NEW_IMAGE" == "$CURRENT_IMAGE" ] && [ "$IMAGE_COUNT" -gt 1 ]; then
            echo "–í—ã–±—Ä–∞–Ω–∞ —Ç–∞ –∂–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é..."
            RANDOM_LINE=$((RANDOM % IMAGE_COUNT + 1))
            NEW_IMAGE=$(echo "$IMAGES" | sed -n "${RANDOM_LINE}p")
            echo "–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞: $NEW_IMAGE"
          fi
          
          # –ó–∞–º–µ–Ω—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ README (–∏—â–µ–º –ª—é–±—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Å width="350")
          sed -i "s|<img src=\"[^\"]*\" width=\"350\"|<img src=\"$NEW_IMAGE\" width=\"350\"|g" README.md
          
          echo "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
          
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if git diff --staged --quiet; then
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          else
            git commit -m "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (Loona)"
            git push
          fi
